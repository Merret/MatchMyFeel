<!DOCTYPE html>
<html>
<head>
    <title>InRoom - Match My Feel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/combine/gh/Merret/UsefulJS@0.5.3/js/element.min.js,gh/Merret/UsefulJS@0.5.3/js/urldata.min.js,gh/Merret/UsefulJS@0.5.3/js/xhr.min.js"></script>
    <script src="js/userInfo.js"></script>
    <link rel="stylesheet" type="text/css" href="css/room.css">
</head>
<body>
    <h1 id="Status">Checking Room Status...</h1>
    <script>
        var roomCode = urldata("code");
        var userControl = xhr.json("https://api.myjson.com/bins/"+roomCode);
        if(urldata("mine")!=1) {
            if(userControl.users.length > 2) {
                location.href = "./?msg=Sorry! The room is full.";
            } else {
                waitUserInfo(1);
            }
        } else {
            elm.id("Status").innerHTML = "Share Room Code: " + roomCode;
            var WaitInterval = setInterval(function() {waitAnother();}, 1000);
        }
        function waitUserInfo(hs) {
            if(userInfo.ip && userInfo.device) {
                joinRoom();
            } else {
                console.log("Waited For " + 0.5*hs + "s.");
                setTimeout(function() {waitUserInfo(hs+1);}, 500);
            }
        }
        function joinRoom() {
            elm.id("Status").innerHTML = "Joining Room...";
            var uI = {
                "ip": userInfo.ip,
                "device": userInfo.device.device.vendor + " " + userInfo.device.device.model
            };
            this.userControl.users.push(uI);
            this.userControl = JSON.parse(xhr.put("https://api.myjson.com/bins/"+roomCode, JSON.stringify(userControl)));
            if(JSON.stringify(this.userControl.users[1]) == JSON.stringify(uI)) {
                elm.id("Status").innerHTML = "Joined Room!";
                prepareQuestions();
            }
        }
        function waitAnother() {
            var x = xhr.json("https://api.myjson.com/bins/"+roomCode);
            if(x.users.length>1) {
                clearInterval(WaitInterval);
                elm.id("Status").innerHTML = "User Joined! Using " + x.users[1].device + " at " + x.users[1].ip;
                prepareQuestions();
            }
        }
        function prepareQuestions() {
            console.log("Start Prepare Questions.");
        }
    </script>
</body>
</html>
